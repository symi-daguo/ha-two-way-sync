# Home Assistant SYMI双向同步集成

<div align="center">

[![hacs_badge](https://img.shields.io/badge/HACS-Custom-orange.svg)](https://github.com/hacs/integration)
[![GitHub release](https://img.shields.io/github/release/symi-daguo/ha-two-way-sync.svg)](https://github.com/symi-daguo/ha-two-way-sync/releases)
[![License](https://img.shields.io/github/license/symi-daguo/ha-two-way-sync.svg)](LICENSE)
[![Home Assistant](https://img.shields.io/badge/Home%20Assistant-2024.1.0+-blue.svg)](https://www.home-assistant.io/)

</div>

一个简单易用的 Home Assistant 自定义集成，用于实现两个实体之间的双向状态同步。

## 🎉 V2.1.9 正式版发布（2025年9月10日）

### 🔧 重大修复
- **彻底解决"实体不存在"问题**: 修复启动时序问题，支持延迟启动和自动重试
- **增强防死循环机制**: 添加同步源跟踪，防止反向触发
- **改进错误恢复**: 自动处理网络中断、设备重启、OTA更新等突发事件
- **优化性能和稳定性**: 减少不必要检查，改进资源管理

### ✨ 核心功能
- **完善的双向同步**: 开关、调光、窗帘双向同步功能全面稳定
- **智能实体检查**: 定期检查实体可用性，自动恢复同步
- **集成重新加载支持**: 新增reload服务，无需重启HA即可重新加载集成
- **增强错误恢复机制**: 自动重连、异常处理，确保系统高可用性
- **健康监控**: 实体状态检查和健康监控，定期检查实体可用性
- **稳定的自动恢复**: 后台自动恢复功能，处理各种突发情况
- **防死循环机制**: 增强的防循环同步机制，确保系统稳定运行
- **详细日志记录**: 优化的调试信息和性能监控，便于问题诊断

## ✨ 功能特性

- � **零容忍步进干扰**: 有步进设备完全禁用状态监听，只镜像用户操作
- ⚡ **纯服务调用模式**: 检测到用户操作时立即镜像控制命令，绝不等待状态反馈
- 🛡️ **多重防护机制**: 彻底消除死循环和步进过程中断问题
- 🔧 **易配置**: 通过 Home Assistant UI 界面轻松配置
- 📱 **广泛支持**: 支持灯光、开关、窗帘、风扇、空调、媒体播放器、数字输入、选择器等多种设备类型
- 🎛️ **服务支持**: 提供手动同步、切换同步状态和重新加载集成的服务
- 🔄 **重新加载**: 支持集成重新加载，无需重启HA即可恢复集成功能
- 🛠️ **错误恢复**: 自动处理网络中断、设备重启、OTA更新等突发事件
- 🎨 **色温标准化**: 自动限制色温范围到2700K-6500K，确保兼容性

## 📋 系统要求

- Home Assistant 2024.1.0 或更高版本
- Python 3.12 或更高版本（推荐）
- HACS（可选，用于自动更新）

## 🚀 安装方法

### 方法一：通过 HACS 安装

**当前状态**: HACS 收录申请正在处理中，暂时需要通过自定义存储库安装

1. 确保已安装 [HACS](https://hacs.xyz/)
2. 在 HACS 中点击 "集成"
3. 点击右上角的三个点，选择 "自定义存储库"
4. 添加存储库 URL: `https://github.com/symi-daguo/ha-two-way-sync`
5. 类别选择 "集成"
6. 搜索并安装 "Home Assistant 双向同步集成"
7. 重启 Home Assistant

> **未来**: 一旦 HACS 收录申请通过，您将可以直接在 HACS 默认存储库中搜索并安装此集成。

### 方法二：手动安装

1. 下载最新版本的代码
2. 解压后将整个 `custom_components/ha_two_way_sync` 文件夹复制到你的 Home Assistant 配置目录下的 `custom_components` 文件夹中
3. 确保目录结构如下：
   ```
   config/
   └── custom_components/
       └── ha_two_way_sync/
           ├── __init__.py
           ├── config_flow.py
           ├── manifest.json
           ├── services.yaml
           └── translations/
               ├── en.json
               └── zh.json
   ```
4. 重启 Home Assistant

## ⚙️ 配置说明

### 添加集成

1. 在 Home Assistant 的 "设置" > "设备与服务" 中点击 "添加集成"
2. 搜索并选择 "Home Assistant 双向同步集成"
3. 按照向导完成配置：
   - 选择要同步的第一个实体
   - 选择要同步的第二个实体
   - 完成配置

### 支持的设备类型

| 设备类型 | 域名 | 同步类型 | 说明 |
|---------|------|----------|------|
| 灯光 | `light` | 完美同步 | 同步状态、亮度、RGB颜色、HS颜色、色温、效果 |
| 开关 | `switch` | 完美同步 | 同步开关状态 |
| 窗帘 | `cover` | 完美同步 | 同步开关状态、位置、倾斜角度 |
| 风扇 | `fan` | 完美同步 | 同步状态、速度百分比 |
| 空调 | `climate` | 完美同步 | 同步温度、HVAC模式、风扇模式 |
| 媒体播放器 | `media_player` | 完美同步 | 同步播放状态、音量等属性 |
| 数字输入 | `number` | 完美同步 | 同步数值 |
| 输入数字 | `input_number` | 完美同步 | 同步数值 |
| 选择器 | `select` | 完美同步 | 同步选中选项 |
| 输入选择 | `input_select` | 完美同步 | 同步选中选项 |
| 输入布尔 | `input_boolean` | 完美同步 | 同步开关状态 |
| 场景 | `scene` | 基础同步 | 触发场景 |
| 脚本 | `script` | 基础同步 | 执行脚本 |
| 自动化 | `automation` | 基础同步 | 开关状态同步 |
| 输入布尔 | `input_boolean` | 完美同步 | 同步开关状态 |
| 输入选择 | `input_select` | 完美同步 | 同步选项值 |
| 输入数字 | `input_number` | 完美同步 | 同步数值 |
| 输入文本 | `input_text` | 完美同步 | 同步文本内容 |
| 二进制传感器 | `binary_sensor` | 基础同步 | 只读，不支持同步 |
| 传感器 | `sensor` | 基础同步 | 只读，不支持同步 |
| 锁 | `lock` | 基础同步 | 开关状态同步 |

## 💡 使用示例

### 示例一：客厅主灯与辅助灯同步
- **实体1**: `light.living_room_main` (客厅主灯)
- **实体2**: `light.living_room_auxiliary` (客厅辅助灯)
- **效果**: 两个灯光的开关状态、亮度、颜色完全同步

### 示例二：卧室开关与床头灯同步
- **实体1**: `switch.bedroom_wall_switch` (墙壁开关)
- **实体2**: `light.bedside_lamp` (床头灯)
- **效果**: 墙壁开关控制床头灯，床头灯状态也会反映到开关上

### 示例三：窗帘与智能开关同步
- **实体1**: `cover.living_room_curtain` (客厅窗帘)
- **实体2**: `switch.curtain_control` (窗帘控制开关)
- **效果**: 开关控制窗帘开合，窗帘状态同步到开关

## 🛠️ 可用服务

集成提供以下服务供自动化使用：

### `ha_two_way_sync.manual_sync`
手动触发同步操作

```yaml
service: ha_two_way_sync.manual_sync
data:
  config_entry_id: "your_config_entry_id"
```

### `ha_two_way_sync.toggle_sync`
切换同步状态（启用/禁用）

```yaml
service: ha_two_way_sync.toggle_sync
data:
  config_entry_id: "your_config_entry_id"
```

### `ha_two_way_sync.reload`
重新加载所有双向同步配置

```yaml
service: ha_two_way_sync.reload
```

## � 更新日志

### [2.1.9] - 2025-09-10
**🔧 修复API兼容性问题**
- 🚨 **修复导入错误**: 解决`async_track_service_calls`不存在的问题
- 🔄 **改用事件监听**: 使用`call_service`事件监听服务调用，确保兼容性
- ⚡ **保持核心功能**: 维持纯服务调用监听模式，彻底避免步进设备状态同步
- 🛡️ **多重防护**: 继续保持多重防护机制，确保无死循环

**技术改进**
- 📡 **事件监听**: 使用Home Assistant核心事件系统监听服务调用
- 🔧 **模拟对象**: 创建MockServiceCall对象保持代码兼容性
- 🎯 **精确分发**: 根据域名精确分发到对应的处理器
- 📊 **异步处理**: 使用async_create_task确保异步处理

**解决的问题**
- ❌ **配置向导加载失败**: 修复"Invalid handler specified"错误
- ❌ **导入模块错误**: 解决async_track_service_calls导入失败
- ❌ **集成无法添加**: 恢复正常的配置流程

### [2.1.8] - 2025-09-10
**🔥 彻底解决步进设备死循环问题**
- 🚨 **零容忍状态同步**: 有步进设备(light/cover)完全禁用状态变化监听
- ⚡ **纯服务调用模式**: 只监听用户操作，立即镜像控制命令，绝不等待状态反馈
- 🛡️ **多重防护机制**: 在监听器设置和状态处理中都添加严格检查
- 🎯 **零延迟响应**: 使用blocking=False确保服务调用立即执行

**技术突破**
- 📡 **智能监听策略**: 自动检测设备类型，有步进设备强制使用服务调用监听
- 🔄 **完美镜像**: 完全复制用户操作到目标设备，包括所有参数
- 🎨 **色温标准化**: 2700K-6500K范围限制，支持新旧格式自动转换
- 📊 **详细调试**: 清晰的日志记录，便于问题排查

**解决的关键问题**
- ❌ **3秒回弹停止**: 完全消除状态同步导致的步进过程中断
- ❌ **动作未完成就同步**: 只镜像用户操作，不监听中间状态
- ❌ **死循环现象**: 多重防护确保绝不会出现循环同步

### [2.1.7] - 2025-09-09
**🔥 革命性同步策略**
- 🚀 **彻底解决死循环**: 对有步进过程的设备（调光、窗帘）改用服务调用监听，完全避免状态反馈导致的死循环
- 🎯 **直接控制同步**: 检测到用户操作时立即镜像相同的控制命令，不等待状态变化反馈
- 🔧 **色温范围标准化**: 统一色温范围为2700K-6500K，自动限制超出范围的值
- ⚡ **即时响应**: 用户操作设备A时，设备B立即执行相同操作，无延迟

**同步策略重新设计**
- 💡 **灯光设备**: 监听light服务调用（turn_on/turn_off），直接镜像所有参数
- 🪟 **窗帘设备**: 监听cover服务调用（set_position/open/close），直接镜像所有参数
- 🔌 **开关设备**: 继续使用状态变化监听，因为开关是即时生效的
- 🛡️ **防循环机制**: 跟踪自己发起的服务调用，避免无限循环

**技术突破**
- 📡 **服务调用监听**: 使用async_track_service_calls监听用户操作
- 🔄 **命令镜像**: 完全复制服务调用参数到目标设备
- 🎨 **色温处理**: 支持新旧格式转换，自动限制到标准范围
- 📊 **智能日志**: 详细记录服务调用镜像过程

### [2.1.6] - 2025-09-09
**重大修复**
- 🐛 **修复色温同步问题**: 解决色温控制时两个设备反向同步的关键问题
- 🎯 **智能颜色检测**: 改进颜色属性变化检测，确保色温变化能被正确同步
- 🔄 **优化同步逻辑**: 检测具体变化的属性并优先同步，而不是按固定优先级
- 🛡️ **防冲突增强**: 进一步优化颜色属性冲突处理机制

**新增设备支持**
- 🌡️ **空调设备**: 支持温度、HVAC模式、风扇模式同步
- 🎵 **媒体播放器**: 支持播放状态、音量同步
- 🔢 **数字输入**: 支持number、input_number数值同步
- 📋 **选择器**: 支持select、input_select选项同步
- ✅ **布尔输入**: 支持input_boolean开关状态同步

**同步策略优化**
- ⚡ **色温同步**: 独立检测色温变化，不受其他颜色属性影响
- 🎯 **智能检测**: 比较源设备和目标设备状态，只同步真正变化的属性
- 📊 **详细日志**: 添加所有新设备类型的详细调试信息
- 🔧 **错误处理**: 改进数值转换和服务调用的错误处理

### [2.1.4] - 2025-09-09
**重大修复**
- 🐛 彻底修复"实体不存在，无法设置同步"的关键问题
- 🔄 解决HA启动时实体尚未加载导致的同步设置失败
- 🛡️ 增强防循环同步机制，添加同步源跟踪
- 🔧 改进错误处理和自动恢复机制

**新增功能**
- ⏰ 延迟启动机制，给HA时间加载所有实体
- 🔍 实体检查重试，定期检查实体可用性并自动恢复同步
- 📊 健康检查，定期监控实体状态变化
- 🔄 智能重载，完善reload服务支持一键重载集成

**技术改进**
- 🛠️ 大幅提升集成稳定性，支持HA重启、断网等突发情况
- 📝 优化日志记录，减少错误日志，增加调试信息
- ⚡ 优化同步性能，减少不必要的检查
- 🧹 代码清理，删除不需要的文件，优化代码结构

### [2.1.3] - 2025-09-03
- 🐛 修复集成无法在Home Assistant中正常添加的关键问题
- 📁 补充缺失的services.yaml、strings.json和translations文件
- 🔧 修复manifest.json配置不完整导致的加载失败
- 🌐 恢复完整的中英文界面支持

## �🔧 故障排除

### 常见问题

1. **同步不工作**
   - 检查实体ID是否正确
   - 确认两个实体都存在且可用
   - 等待2-5分钟让集成自动检测实体
   - 使用reload服务重新加载集成
   - 查看 Home Assistant 日志中的错误信息

2. **实体不存在错误**
   - v2.1.4已修复此问题，更新后等待自动恢复
   - 如仍有问题，使用reload服务强制重新加载
   - 确认实体在HA中确实存在且可用

3. **启用调试日志**
   ```yaml
   # configuration.yaml
   logger:
     default: warning
     logs:
       custom_components.ha_two_way_sync: debug
   ```

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

1. Fork 这个仓库
2. 创建功能分支 (`git checkout -b feature/amazing-feature`)
3. 提交你的更改 (`git commit -m 'Add some amazing feature'`)
4. 推送到分支 (`git push origin feature/amazing-feature`)
5. 创建 Pull Request

## 📄 许可证

本项目采用 MIT 许可证 - 查看 [LICENSE](LICENSE) 文件了解详情。

## 📞 支持

- **GitHub Issues**: [提交问题](https://github.com/symi-daguo/ha-two-way-sync/issues)
- **邮箱**: 303316404@qq.com

## 📚 相关文档

- **[LICENSE](LICENSE)**: 项目许可证

## 🏷️ HACS 收录信息

本项目正在申请加入 HACS 默认存储库，相关进展：

- **Brands 仓库**: 已提交 SYMI 品牌图标 PR [#7818](https://github.com/home-assistant/brands/pull/7818)
- **HACS 默认仓库**: 等待 Brands PR 合并后重新提交收录申请
- **收录要求**: 已满足所有 HACS 收录要求（GitHub Release、仓库描述、Topics、品牌图标等）

---

**当前版本**: V2.1.4
**发布日期**: 2025年9月9日
**兼容性**: Home Assistant 2024.1.0+
**测试版本**: Home Assistant 2024.12.x
**HACS 状态**: 收录申请中